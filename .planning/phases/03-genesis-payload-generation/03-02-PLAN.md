---
phase: 03-genesis-payload-generation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs
  - src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs
  - chainweb.cabal
  - src/Chainweb/Version/Stoa.hs
autonomous: true

must_haves:
  truths:
    - "Ea tool generates Stoa0Payload.hs and Stoa1to9Payload.hs without errors"
    - "Generated payload modules contain hash-verified payloadBlock definitions"
    - "Stoa.hs imports real Stoa payloads instead of temporary Development payloads"
    - "The full project compiles with the real genesis payloads wired in"
  artifacts:
    - path: "src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs"
      provides: "Chain 0 genesis payload (coin + namespaces + keysets + init)"
      contains: "payloadBlock"
      min_lines: 10
    - path: "src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs"
      provides: "Chains 1-9 genesis payload (coin + namespaces only)"
      contains: "payloadBlock"
      min_lines: 10
    - path: "src/Chainweb/Version/Stoa.hs"
      provides: "Stoa version with real genesis payloads"
      contains: "Stoa0Payload"
    - path: "chainweb.cabal"
      provides: "Module registration for genesis payloads"
      contains: "Stoa0Payload"
  key_links:
    - from: "src/Chainweb/Version/Stoa.hs"
      to: "src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs"
      via: "import qualified + payloadBlock reference"
      pattern: "import qualified.*Stoa0Payload"
    - from: "src/Chainweb/Version/Stoa.hs"
      to: "src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs"
      via: "import qualified + payloadBlock reference"
      pattern: "import qualified.*Stoa1to9Payload"
    - from: "chainweb.cabal"
      to: "src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs"
      via: "exposed-modules listing"
      pattern: "Chainweb\\.BlockHeader\\.Genesis\\.Stoa0Payload"
---

<objective>
Run the Ea tool to generate genesis payload Haskell modules, wire them into the Stoa version, and verify the full project compiles.

Purpose: This is the culmination of Phase 3 -- the Ea tool executes the genesis YAML transactions against a temporary Pact runtime, captures the resulting payloads, and writes them as auto-generated Haskell modules. These modules are then wired into the Stoa version definition, replacing the temporary Development payloads from Phase 2.

Output: Two auto-generated payload modules (`Stoa0Payload.hs`, `Stoa1to9Payload.hs`), updated `Stoa.hs` with real imports, updated `chainweb.cabal`, and a successful `cabal build`.
</objective>

<execution_context>
@/Users/codera/.claude/get-shit-done/workflows/execute-plan.md
@/Users/codera/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-genesis-payload-generation/03-RESEARCH.md
@.planning/phases/03-genesis-payload-generation/03-01-SUMMARY.md

Key source files to read before implementing:
@src/Chainweb/Version/Stoa.hs (current Stoa version with temporary DN0/DNN imports)
@chainweb.cabal (lines 134-161 for genesis module registration pattern)
@cwtools/ea/Ea.hs (Ea tool main -- to understand how to run it)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Ea tool and register generated modules</name>
  <files>
    src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs
    src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs
    chainweb.cabal
  </files>
  <action>
**Step 1: Run the Ea tool.**

The Ea tool must be run from the `stoa-chain/` directory (because all YAML file paths in Genesis.hs are relative to the project root, e.g., `"pact/genesis/stoa/load-stoa-coin.yaml"`).

```bash
cd stoa-chain && cabal run ea
```

This will generate ALL genesis payload modules (for all versions, including Stoa). The Stoa-specific outputs will be:
- `src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs`
- `src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs`

The tool prints progress messages like `"Generating Genesis Payload for stoa on Chain 0..."` and `"Generating Genesis Payload for stoa on Chains 1-9..."`.

**IMPORTANT:** The Ea tool runs concurrently and generates payloads for ALL configured versions (recapDevnet, devnet, fastnet, etc.), not just Stoa. This is expected -- it regenerates everything. Do not be alarmed by the volume of output. The tool should print "Done." at the end.

**If the Ea tool fails with errors:**
- "Keyset not found" or "Stoa Masters Permission not satisfied" -- the keysets YAML or init YAML has issues with key matching. Check that init-chain0.yaml's `keyPairs` public key matches one of the keys in keysets.yaml.
- "File not found" -- a `codeFile` path is wrong. Check relative paths from YAML file location.
- "Prelude.the: not all elements are equal" -- chains in a range are producing different payloads. Verify stoaN has no chain-specific data.
- "unknown version" -- `registerVersion stoa` is missing from Ea.hs main.

**Step 2: Verify generated files exist and look correct.**

Check that both files were generated:
```bash
ls -la src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs
ls -la src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs
```

Each file should:
- Start with `{-# LANGUAGE OverloadedStrings #-}`
- Contain `module Chainweb.BlockHeader.Genesis.StoaXPayload ( payloadBlock ) where`
- Have `payloadBlock :: HasCallStack => PayloadWithOutputs`
- Include a hash check (`actualHash == expectedHash`)

**Step 3: Add generated modules to `chainweb.cabal`.**

In `chainweb.cabal`, find the `exposed-modules:` block that lists the existing genesis payload modules (around lines 134-161, look for the block containing `Chainweb.BlockHeader.Genesis.Development0Payload`, etc.).

Add the two new modules IN ALPHABETICAL ORDER within the existing genesis block:
```
        , Chainweb.BlockHeader.Genesis.Stoa0Payload
        , Chainweb.BlockHeader.Genesis.Stoa1to9Payload
```

Place them after the `RecapDevelopment*` entries and before the `Testnet*` entries (alphabetically "Stoa" comes after "Recap..." and "Quirked..." but before "Testnet"). The exact position within the genesis block doesn't matter functionally, but maintaining alphabetical order follows convention.
  </action>
  <verify>
Verify generated modules exist and have expected content:
```bash
head -10 src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs
head -10 src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs
grep "payloadBlock" src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs | head -3
grep "payloadBlock" src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs | head -3
```

Verify modules are registered in cabal:
```bash
grep "Stoa0Payload\|Stoa1to9Payload" chainweb.cabal
```
Should show both module names in the exposed-modules list.
  </verify>
  <done>
`Stoa0Payload.hs` and `Stoa1to9Payload.hs` exist in `src/Chainweb/BlockHeader/Genesis/` with valid hash-verified `payloadBlock` definitions. Both are registered in `chainweb.cabal` exposed-modules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire real payloads into Stoa.hs and verify build</name>
  <files>
    src/Chainweb/Version/Stoa.hs
  </files>
  <action>
**Step 1: Update imports in `Stoa.hs`.**

Replace the temporary Development payload imports:
```haskell
-- REMOVE these two lines:
import qualified Chainweb.BlockHeader.Genesis.Development0Payload as DN0
import qualified Chainweb.BlockHeader.Genesis.Development1to19Payload as DNN

-- ADD these two lines:
import qualified Chainweb.BlockHeader.Genesis.Stoa0Payload as S0
import qualified Chainweb.BlockHeader.Genesis.Stoa1to9Payload as SN
```

**Step 2: Update `_genesisBlockPayload` references.**

In the `stoa` version definition, update the payload references:
```haskell
-- CHANGE from:
        , _genesisBlockPayload = onChains $ concat
            [ [(unsafeChainId 0, DN0.payloadBlock)]
            , [(unsafeChainId i, DNN.payloadBlock) | i <- [1..9]]
            ]

-- TO:
        , _genesisBlockPayload = onChains $ concat
            [ [(unsafeChainId 0, S0.payloadBlock)]
            , [(unsafeChainId i, SN.payloadBlock) | i <- [1..9]]
            ]
```

**Step 3: Update the module doc comment.**

Change the module comment from:
```haskell
-- | Stoa chain version definition. Uses devnet genesis payloads temporarily
-- (Phase 3 generates real ones).
```
To:
```haskell
-- | Stoa chain version definition.
```

**Step 4: Build the full project.**

```bash
cd stoa-chain && cabal build chainweb 2>&1 | tail -30
```

This must compile with zero warnings (`-Wall -Werror` is enabled). The build confirms:
- Generated payload modules parse correctly
- Hash verification in payload modules is consistent
- `Stoa.hs` correctly references the new imports
- All 237+ modules compile clean

If compilation fails with "Could not find module 'Chainweb.BlockHeader.Genesis.Stoa0Payload'", the module was not added to `chainweb.cabal` exposed-modules (fix in Task 1).

If compilation fails with type errors, the generated modules may have an unexpected format -- check that `payloadBlock` has type `PayloadWithOutputs` (it should, as Ea generates it consistently).
  </action>
  <verify>
Build succeeds:
```bash
cd stoa-chain && cabal build chainweb 2>&1 | grep -E "Building|modules|warning|error" | tail -10
```
Should show all modules building with zero warnings/errors.

Verify Stoa.hs no longer references Development payloads:
```bash
grep "Development" src/Chainweb/Version/Stoa.hs  # should return nothing
grep "Stoa0Payload\|Stoa1to9Payload" src/Chainweb/Version/Stoa.hs  # should show import lines
```

Verify the build also works for chainweb-node (the actual node executable):
```bash
cd stoa-chain && cabal build chainweb-node 2>&1 | tail -10
```
  </verify>
  <done>
`Stoa.hs` imports `Stoa0Payload` and `Stoa1to9Payload` (no more Development payload temporaries). `cabal build chainweb` and `cabal build chainweb-node` succeed with zero warnings. The Stoa version definition has real genesis payloads with hash verification.
  </done>
</task>

</tasks>

<verification>
Phase 3 overall verification:
1. `src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs` exists and contains `payloadBlock :: HasCallStack => PayloadWithOutputs`
2. `src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs` exists and contains `payloadBlock :: HasCallStack => PayloadWithOutputs`
3. Both modules are listed in `chainweb.cabal` exposed-modules
4. `Stoa.hs` imports `Stoa0Payload` as `S0` and `Stoa1to9Payload` as `SN`
5. `Stoa.hs` uses `S0.payloadBlock` for chain 0 and `SN.payloadBlock` for chains 1-9
6. `cabal build chainweb` succeeds with zero warnings
7. `cabal build chainweb-node` succeeds
8. Chain 0 payload was generated from 4 transactions (coin deploy + namespaces + keysets + init)
9. Chains 1-9 payload was generated from 2 transactions (coin deploy + namespaces)
</verification>

<success_criteria>
- Ea tool ran successfully and generated both payload modules
- Both generated modules contain hash-verified payloadBlock definitions
- Stoa version uses real payloads (no Development temporaries)
- `cabal build chainweb` and `cabal build chainweb-node` pass with zero warnings
</success_criteria>

<output>
After completion, create `.planning/phases/03-genesis-payload-generation/03-02-SUMMARY.md`
</output>
