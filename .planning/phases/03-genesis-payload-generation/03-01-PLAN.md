---
phase: 03-genesis-payload-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pact/genesis/stoa/load-stoa-coin.yaml
  - pact/genesis/stoa/ns.yaml
  - pact/genesis/stoa/keysets.yaml
  - pact/genesis/stoa/init-chain0.yaml
  - cwtools/ea/Ea/Genesis.hs
  - cwtools/ea/Ea.hs
autonomous: true

must_haves:
  truths:
    - "Genesis YAML files exist for chain 0 (coin deploy + namespaces + keysets + init call)"
    - "Genesis YAML files exist for chains 1-9 (coin deploy + namespaces only)"
    - "Ea tool has Stoa Genesis records (stoa0 for chain 0, stoaN for chains 1-9)"
    - "Ea tool registers Stoa version and includes stoaNet in its main"
  artifacts:
    - path: "pact/genesis/stoa/load-stoa-coin.yaml"
      provides: "YAML transaction to deploy STOA coin contract (bundled interfaces)"
      contains: "codeFile"
    - path: "pact/genesis/stoa/ns.yaml"
      provides: "YAML transaction to install namespace module"
      contains: "ns-install.pact"
    - path: "pact/genesis/stoa/keysets.yaml"
      provides: "YAML transaction defining 7 Stoa Master keysets"
      contains: "stoa-ns.stoa_master_one"
    - path: "pact/genesis/stoa/init-chain0.yaml"
      provides: "YAML transaction calling A_InitialiseStoaChain"
      contains: "A_InitialiseStoaChain"
    - path: "cwtools/ea/Ea/Genesis.hs"
      provides: "stoa0 and stoaN Genesis records with correct file paths"
      contains: "stoa0"
    - path: "cwtools/ea/Ea.hs"
      provides: "Stoa version registration and stoaNet payload generation entry"
      contains: "stoaNet"
  key_links:
    - from: "pact/genesis/stoa/load-stoa-coin.yaml"
      to: "pact/stoa-coin/new-coin.pact"
      via: "codeFile relative path"
      pattern: "codeFile.*new-coin\\.pact"
    - from: "pact/genesis/stoa/ns.yaml"
      to: "pact/namespaces/ns-install.pact"
      via: "codeFile relative path"
      pattern: "codeFile.*ns-install\\.pact"
    - from: "cwtools/ea/Ea/Genesis.hs"
      to: "pact/genesis/stoa/*.yaml"
      via: "FilePath constants"
      pattern: "pact/genesis/stoa"
    - from: "cwtools/ea/Ea.hs"
      to: "cwtools/ea/Ea/Genesis.hs"
      via: "import of stoa0, stoaN"
      pattern: "stoaNet"
---

<objective>
Create all genesis YAML transaction files and Ea tool Genesis records for Stoa.

Purpose: The Ea tool needs YAML files (defining what Pact code to execute at genesis) and Genesis records (defining how to group those YAML files per chain range) before it can generate Haskell payload modules. This plan creates all the input artifacts.

Output: 4 YAML files under `pact/genesis/stoa/`, updated `Ea/Genesis.hs` with `stoa0`/`stoaN` records, updated `Ea.hs` with Stoa version registration and `stoaNet` entry.
</objective>

<execution_context>
@/Users/codera/.claude/get-shit-done/workflows/execute-plan.md
@/Users/codera/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-genesis-payload-generation/03-RESEARCH.md

Key source files to read before implementing:
@cwtools/ea/Ea/Genesis.hs (existing Genesis records and file path pattern)
@cwtools/ea/Ea.hs (existing main function and mkPayloads usage)
@pact/genesis/ns-v2.yaml (reference YAML format for namespaces)
@pact/genesis/devnet/keysets.yaml (reference YAML format for keysets)
@pact/genesis/devnet/grants0.yaml (reference YAML format for coinbase/grants)
@pact/coin-contract/load-coin-contract.yaml (reference YAML for loading pact files)
@pact/stoa-coin/stoa-coin.repl (lines 10-33 for keyset definition pattern, lines 143-165 for A_InitialiseStoaChain usage)
@src/Chainweb/Version/Stoa.hs (current Stoa version -- needed by Genesis records)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create STOA genesis YAML transaction files</name>
  <files>
    pact/genesis/stoa/load-stoa-coin.yaml
    pact/genesis/stoa/ns.yaml
    pact/genesis/stoa/keysets.yaml
    pact/genesis/stoa/init-chain0.yaml
  </files>
  <action>
Create the directory `pact/genesis/stoa/` and 4 YAML files. All files use the standard Pact `mkApiReq` YAML format (see `pact/genesis/devnet/keysets.yaml` and `pact/coin-contract/load-coin-contract.yaml` as references).

**IMPORTANT path resolution:** `codeFile` paths are resolved relative to the YAML file's directory, NOT the project root. Since these YAML files will be in `pact/genesis/stoa/`, paths to files in `pact/stoa-coin/` need `../../stoa-coin/` and paths to `pact/namespaces/` need `../../namespaces/`.

**Key generation:** Generate 7 unique Ed25519 key pairs (public + secret) for the Stoa Master keysets, plus 1 key pair for the foundation account. Use `pact -g` (the Pact key generation tool) to create real Ed25519 key pairs. Run `pact -g` 8 times to get 8 unique key pairs. If `pact` is not available, use `openssl rand -hex 32` to generate 32-byte hex strings for public keys and corresponding 64-byte hex strings for secret keys (matching the format seen in devnet: `"368820f80c324bbc7c2b0610688a7da43e39f91d118732671cd9c7500ff43cca"`). These are DEV keys -- they will be replaced before mainnet launch.

**File 1: `load-stoa-coin.yaml`** -- Deploys the STOA coin contract (which bundles all 4 interfaces inline):
```yaml
codeFile: ../../stoa-coin/new-coin.pact
nonce: stoa-coin-deploy
keyPairs: []
```
No `data` section needed -- the contract self-contains all definitions. No `keyPairs` because genesis transactions get GENESIS magic capability. Do NOT create separate interface loading files (STOA bundles interfaces, unlike Kadena's pattern).

**File 2: `ns.yaml`** -- Installs namespace module (following ns-v2.yaml pattern):
```yaml
codeFile: ../../namespaces/ns-install.pact
data:
  ns-admin-keyset: ["<master-key-1-public>"]
  ns-operate-keyset: ["<master-key-1-public>"]
  ns-genesis-keyset:
    keys: []
    pred: "="
nonce: stoa-namespaces
keyPairs: []
```
Use one of the master keys for ns-admin and ns-operate (same pattern as devnet's ns-v2.yaml which uses sender00 key).

**File 3: `keysets.yaml`** -- Defines the 7 Stoa Master keysets:
```yaml
code: |-
  (define-keyset "stoa-ns.stoa_master_one" (read-keyset "stoa-ns.stoa_master_one"))
  (define-keyset "stoa-ns.stoa_master_two" (read-keyset "stoa-ns.stoa_master_two"))
  (define-keyset "stoa-ns.stoa_master_three" (read-keyset "stoa-ns.stoa_master_three"))
  (define-keyset "stoa-ns.stoa_master_four" (read-keyset "stoa-ns.stoa_master_four"))
  (define-keyset "stoa-ns.stoa_master_five" (read-keyset "stoa-ns.stoa_master_five"))
  (define-keyset "stoa-ns.stoa_master_six" (read-keyset "stoa-ns.stoa_master_six"))
  (define-keyset "stoa-ns.stoa_master_seven" (read-keyset "stoa-ns.stoa_master_seven"))
data:
  stoa-ns.stoa_master_one: ["<master-key-1-public>"]
  stoa-ns.stoa_master_two: ["<master-key-2-public>"]
  stoa-ns.stoa_master_three: ["<master-key-3-public>"]
  stoa-ns.stoa_master_four: ["<master-key-4-public>"]
  stoa-ns.stoa_master_five: ["<master-key-5-public>"]
  stoa-ns.stoa_master_six: ["<master-key-6-public>"]
  stoa-ns.stoa_master_seven: ["<master-key-7-public>"]
nonce: stoa-keysets
keyPairs: []
```
Each keyset gets a unique public key. These are flat keyset names (the "stoa-ns." prefix is a naming convention, not a Pact namespace).

**File 4: `init-chain0.yaml`** -- Calls `A_InitialiseStoaChain` on chain 0:
```yaml
code: |-
  (coin.A_InitialiseStoaChain "stoa-foundation" (read-keyset "foundation-ks"))
data:
  foundation-ks: ["<foundation-public-key>"]
  stoa-ns.stoa_master_one: ["<master-key-1-public>"]
nonce: stoa-init-chain0
keyPairs:
  - public: "<master-key-1-public>"
    secret: "<master-key-1-secret>"
```
CRITICAL: This file MUST include a `keyPairs` entry because `A_InitialiseStoaChain` calls `with-capability (GOVERNANCE)` which calls `enforce-one` over `keyset-ref-guard` for the 7 master keysets. At least one keyset must be satisfiable -- so we include master key 1's public+secret. The `stoa-ns.stoa_master_one` entry in `data` is also needed so the keyset guard can be verified.

The `foundation-ks` provides the guard for the foundation account that will receive 16M STOA. Use a distinct key pair for the foundation account (not one of the master keys).
  </action>
  <verify>
All 4 YAML files exist:
```bash
ls pact/genesis/stoa/load-stoa-coin.yaml pact/genesis/stoa/ns.yaml pact/genesis/stoa/keysets.yaml pact/genesis/stoa/init-chain0.yaml
```
Verify `codeFile` paths resolve correctly:
```bash
# From pact/genesis/stoa/, verify relative paths exist
test -f pact/stoa-coin/new-coin.pact && echo "coin contract exists"
test -f pact/namespaces/ns-install.pact && echo "ns-install exists"
```
Verify YAML structure is valid (no syntax errors):
```bash
# Each file should be valid YAML
python3 -c "import yaml; yaml.safe_load(open('pact/genesis/stoa/load-stoa-coin.yaml'))" 2>&1
python3 -c "import yaml; yaml.safe_load(open('pact/genesis/stoa/keysets.yaml'))" 2>&1
python3 -c "import yaml; yaml.safe_load(open('pact/genesis/stoa/ns.yaml'))" 2>&1
python3 -c "import yaml; yaml.safe_load(open('pact/genesis/stoa/init-chain0.yaml'))" 2>&1
```
Verify init-chain0.yaml has keyPairs with both public and secret fields:
```bash
grep -c "secret:" pact/genesis/stoa/init-chain0.yaml  # should be >= 1
```
  </verify>
  <done>
4 YAML files exist in `pact/genesis/stoa/` with valid syntax, correct relative paths to Pact source files, 7 unique master key public keys in keysets.yaml, a foundation key in init-chain0.yaml, and a signing keypair in init-chain0.yaml's keyPairs section.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Stoa Genesis records and Ea tool entry</name>
  <files>
    cwtools/ea/Ea/Genesis.hs
    cwtools/ea/Ea.hs
  </files>
  <action>
**In `cwtools/ea/Ea/Genesis.hs`:**

1. Add import for Stoa version:
```haskell
import Chainweb.Version.Stoa
```

2. Add to the export list (after the Devnet section):
```haskell
  -- * Stoa Genesis Txs
, stoa0
, stoaN
```

3. Add FilePath constants for the 4 YAML files (follow the naming pattern of `devKeysets`, `dev0Grants`, `devNs2`, etc.):
```haskell
-- ---------------------------------------------------------------------- --
-- Stoa

stoaCoinContract :: FilePath
stoaCoinContract = "pact/genesis/stoa/load-stoa-coin.yaml"

stoaNs :: FilePath
stoaNs = "pact/genesis/stoa/ns.yaml"

stoaKeysets :: FilePath
stoaKeysets = "pact/genesis/stoa/keysets.yaml"

stoaInitChain0 :: FilePath
stoaInitChain0 = "pact/genesis/stoa/init-chain0.yaml"
```

4. Add Genesis records:
```haskell
stoa0 :: Genesis
stoa0 = Genesis
    { _version = Stoa
    , _tag = "Stoa"
    , _txChainIds = onlyChainId 0
    , _coinbase = Just stoaInitChain0    -- A_InitialiseStoaChain call (goes in 'coinbase' slot = last in tx order)
    , _keysets = Just stoaKeysets         -- 7 Stoa Master keysets
    , _allocations = Nothing             -- STOA doesn't use allocations
    , _namespaces = Just stoaNs          -- Namespace installation
    , _coinContract = [stoaCoinContract] -- Single file: bundled interfaces + coin module
    }

stoaN :: Genesis
stoaN = stoa0
    & txChainIds .~ mkChainIdRange 1 9
    & coinbase .~ Nothing       -- No init call on chains 1-9 (UEV_ChainZero would fail)
    & keysets .~ Nothing         -- No master keysets on chains 1-9
```

CRITICAL transaction ordering context: The Ea tool builds the transaction list as `cc <> ns <> k <> a <> c` where:
- `cc` = `_coinContract` (coin contract deploy) -- FIRST
- `ns` = `_namespaces` (namespace install) -- SECOND
- `k` = `_keysets` (keyset definitions) -- THIRD
- `a` = `_allocations` (none for STOA) -- FOURTH
- `c` = `_coinbase` (init call) -- LAST

This ordering is correct for STOA because:
1. Coin contract must deploy first (defines the module and tables)
2. Namespaces install second (sets up kadena/user/free namespaces)
3. Keysets define third (the 7 master keysets must exist before init call)
4. Init call comes last (requires both coin module and keysets to exist)

For `stoaN` (chains 1-9): `_coinbase` and `_keysets` are `Nothing`, so the tx list is just `[stoaCoinContract, stoaNs]` -- coin contract + namespaces only.

**In `cwtools/ea/Ea.hs`:**

1. Add import for Stoa version:
```haskell
import Chainweb.Version.Stoa (stoa)
```

2. Add version registration in `main` (after the existing `registerVersion Development` line):
```haskell
    registerVersion stoa
```
Note: Use lowercase `stoa` (the value, not the pattern `Stoa`), matching the existing pattern of `registerVersion RecapDevelopment` and `registerVersion Development` which use the version values.

3. Add `stoaNet` to the `mapConcurrently_` list:
```haskell
      , stoaNet
```

4. Add the `stoaNet` definition in the `where` block:
```haskell
    stoaNet = mkPayloads [stoa0, stoaN]
```

Verify the import in Ea.hs -- `stoa` (lowercase) is the `ChainwebVersion` value exported from `Chainweb.Version.Stoa`. The Genesis records in Genesis.hs also need the `Stoa` pattern (or `stoa` value) for the `_version` field. In Genesis.hs, use `import Chainweb.Version.Stoa` which gives access to both `stoa` and the `Stoa` pattern.
  </action>
  <verify>
Verify the Ea tool compiles (this confirms Genesis.hs and Ea.hs are syntactically correct and all imports resolve):
```bash
cd stoa-chain && cabal build ea 2>&1 | tail -20
```
The build should succeed without errors. Note: This does NOT run the Ea tool -- it only compiles it. Running Ea happens in Plan 02.

Check that the exports are correct:
```bash
grep "stoa0" cwtools/ea/Ea/Genesis.hs | head -5
grep "stoaNet" cwtools/ea/Ea.hs
grep "registerVersion stoa" cwtools/ea/Ea.hs
```
  </verify>
  <done>
`Ea/Genesis.hs` has `stoa0` and `stoaN` Genesis records with correct file paths and transaction slot assignments. `Ea.hs` registers the Stoa version and includes `stoaNet = mkPayloads [stoa0, stoaN]` in its concurrent payload generation. `cabal build ea` succeeds.
  </done>
</task>

</tasks>

<verification>
- All 4 YAML files exist in `pact/genesis/stoa/` with valid YAML syntax
- `codeFile` relative paths resolve to existing Pact source files
- `init-chain0.yaml` has `keyPairs` with public+secret for GOVERNANCE satisfaction
- `Ea/Genesis.hs` compiles with `stoa0` and `stoaN` records
- `Ea.hs` compiles with `registerVersion stoa` and `stoaNet` entry
- `cabal build ea` succeeds (proves all Haskell changes are correct)
</verification>

<success_criteria>
- 4 genesis YAML files exist under `pact/genesis/stoa/`
- `cabal build ea` succeeds with zero warnings
- Genesis records correctly map chain 0 to all 4 YAML files and chains 1-9 to coin+namespaces only
</success_criteria>

<output>
After completion, create `.planning/phases/03-genesis-payload-generation/03-01-SUMMARY.md`
</output>
