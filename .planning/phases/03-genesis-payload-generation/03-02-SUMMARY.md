---
phase: 03-genesis-payload-generation
plan: 02
subsystem: genesis
tags: [ea-tool, genesis-payloads, pact-runtime, pact5, chain-metadata, haskell-codegen]

# Dependency graph
requires:
  - phase: 03-genesis-payload-generation
    plan: 01
    provides: "Genesis YAML files and Ea Genesis records for Stoa"
  - phase: 02-version-definition-and-gas-limits
    provides: "Chainweb.Version.Stoa with Stoa pattern and stoa value"
  - phase: 01-stoa-coin-contract
    provides: "new-coin.pact (bundled STOA coin contract with 4 interfaces)"
provides:
  - "Stoa0Payload.hs -- auto-generated genesis payload for chain 0 (4 txs: coin + ns + keysets + init)"
  - "Stoa1to9Payload.hs -- auto-generated genesis payload for chains 1-9 (2 txs: coin + ns)"
  - "Stoa.hs wired to real payloads (no more Development temporaries)"
  - "Ea tool fix: chain-id populated in transaction metadata for correct Pact runtime behavior"
affects: [04-version-wiring, 05-node-testing]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Ea tool now sets chain-id in genesis transaction metadata (required for STOA's UEV_ChainZero enforcement)"
    - "Genesis payloads generated via Pact5 runtime path (all forks at genesis)"

key-files:
  created:
    - "src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs"
    - "src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs"
  modified:
    - "src/Chainweb/Version/Stoa.hs"
    - "chainweb.cabal"
    - "cwtools/ea/Ea.hs"

key-decisions:
  - "Fixed Ea tool to set chain-id in transaction PublicMeta -- STOA coin contract enforces chain-id checks that require accurate metadata"
  - "Use range lower-bound chain-id for multi-chain ranges to preserve the `the` identity check across chains in a range"

patterns-established:
  - "Genesis payload modules are auto-generated by `cabal run ea` and should never be edited manually"
  - "Ea tool chain-id is set to range lower bound for all chains in a range (ensures identical payloads per range)"

# Metrics
duration: 15min
completed: 2026-02-11
---

# Phase 3 Plan 02: Run Ea Tool and Wire Genesis Payloads Summary

**Ea-generated Stoa genesis payload modules with hash verification, wired into Stoa version definition replacing Development temporaries, full build verified (239 modules, zero warnings)**

## Performance

- **Duration:** 15 min
- **Started:** 2026-02-11T00:02:37Z
- **Completed:** 2026-02-11T00:17:59Z
- **Tasks:** 2
- **Files modified:** 51

## Accomplishments
- Generated Stoa0Payload.hs (109KB, 4 genesis transactions) and Stoa1to9Payload.hs (105KB, 2 genesis transactions) via Ea tool
- Fixed Ea tool bug where chain-id was missing from transaction metadata, causing STOA's UEV_ChainZero enforcement to fail
- Replaced temporary Development payload imports in Stoa.hs with real Stoa-specific payload modules
- Full `cabal build chainweb` (239 modules) and `cabal build chainweb-node` succeed with zero warnings

## Task Commits

Each task was committed atomically:

1. **Task 1: Run Ea tool and register generated modules** - `8898a52` (feat)
2. **Task 2: Wire real payloads into Stoa.hs and verify build** - `da59e37` (feat)

## Files Created/Modified
- `src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs` - Auto-generated chain 0 genesis payload (coin deploy + namespaces + keysets + init)
- `src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs` - Auto-generated chains 1-9 genesis payload (coin deploy + namespaces)
- `src/Chainweb/Version/Stoa.hs` - Updated imports from Development to Stoa payloads, removed temporary doc comment
- `chainweb.cabal` - Added Stoa0Payload and Stoa1to9Payload to exposed-modules
- `cwtools/ea/Ea.hs` - Fixed chain-id in transaction metadata, added Word32/Pact.ChainId imports
- All existing genesis payload and transaction modules regenerated (chain-id now populated in metadata)

## Decisions Made
- Fixed Ea tool to populate chain-id in genesis transaction metadata using the range lower-bound chain-id. STOA's coin contract has `UEV_ChainZero` which checks `(chain-data).chain-id == "0"`, and the Pact5 runtime reads chain-id from transaction PublicMeta (not from the chain being processed). Without this fix, chain-id was empty string ("") causing `A_InitialiseStoaChain` to fail even on chain 0.
- Used range lower-bound for multi-chain ranges (e.g., chains 1-9 all get chain-id "1") to preserve the `the` identity check in `mkPayload` which requires all chains in a range to produce identical payloads.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed missing chain-id in Ea tool genesis transaction metadata**
- **Found during:** Task 1 (running Ea tool)
- **Issue:** Ea tool produced transactions with empty chain-id in PublicMeta. STOA's coin contract calls `UEV_ChainZero` which enforces `(at "chain-id" (chain-data)) == "0"`. The Pact5 runtime's `ctxToPublicData` passes the command's PublicMeta directly, so empty chain-id caused enforcement failure on chain 0 and threw `Pact5GenesisCommandFailed`.
- **Fix:** Modified `mkChainwebTxs'` to accept a `Word32` chain-id parameter and set it via `cmdPayload.pMeta.pmChainId` lens. Modified `mkPayload` to pass the range lower-bound chain-id. Added `Pact.Types.ChainId` qualified import and `Data.Word` import.
- **Files modified:** `cwtools/ea/Ea.hs`
- **Verification:** `cabal run ea` completes successfully, generating all payload modules including Stoa
- **Committed in:** `8898a52` (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Essential fix for correctness. The Ea tool could not generate Stoa payloads without it. Also improves metadata accuracy for all other versions. No scope creep.

## Issues Encountered

- Initial Ea run failed with `Pact5GenesisCommandFailed` / `"UR-STOA Operations are restricted to ChainId 0"`. Root cause traced through Pact5 runtime code path: `ctxToPublicData` passes command metadata directly, and YAML-originated transactions had empty chain-id. Resolved by the Ea tool chain-id fix (Deviation 1).
- Second Ea run failed with `GHC.Exts.the: non-identical elements` because per-chain chain-ids produced different payloads within a range. Resolved by using range lower-bound chain-id for all chains in a range.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Phase 3 (Genesis Payload Generation) is now fully complete
- The Stoa version definition has real, hash-verified genesis payloads
- Ready for Phase 4 (Version Wiring) which integrates the Stoa version into the node's version registry
- All genesis data (YAML files, Ea records, generated payload modules, Stoa.hs wiring) is committed and verified

## Self-Check: PASSED

All 3 key files verified present on disk. Both task commits (8898a52, da59e37) verified in git log. `cabal build chainweb` (239 modules) and `cabal build chainweb-node` both succeed with zero warnings.

---
*Phase: 03-genesis-payload-generation*
*Completed: 2026-02-11*
